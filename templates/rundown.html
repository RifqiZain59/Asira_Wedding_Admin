{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex flex-col items-center mb-10 gap-6">
        <div class="flex bg-white border border-stone-200 rounded-2xl p-1 shadow-sm w-full md:w-auto">
            <button onclick="filterRundown('Pagi')" id="tabAkad" 
                    class="flex-1 md:flex-none px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-gold-500 text-white shadow-md shadow-gold-500/20">
                Akad Nikah (Pagi)
            </button>
            <button onclick="filterRundown('Malam')" id="tabResepsi" 
                    class="flex-1 md:flex-none px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-stone-500 hover:text-charcoal-900">
                Resepsi (Malam)
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        <div class="lg:col-span-4">
            <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm sticky top-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="formTitle" class="text-lg font-serif font-bold text-charcoal-900 flex items-center gap-2">
                        <i data-lucide="list-plus" class="w-5 h-5 text-gold-500"></i>
                        Input Kegiatan
                    </h3>
                    <button id="resetBtn" onclick="resetForm()" class="hidden text-[10px] font-bold text-gold-600 hover:underline uppercase tracking-widest">
                        Batal Edit
                    </button>
                </div>
                
                <form id="rundownForm" action="/tambah_rundown" method="POST" class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-bold text-stone-500 mb-1.5 uppercase tracking-widest">Waktu Acara</label>
                        <input type="text" name="waktu" id="f_waktu" placeholder="08:00" class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-gold-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-stone-500 mb-1.5 uppercase tracking-widest">Judul Kegiatan</label>
                        <input type="text" name="judul" id="f_judul" placeholder="Nama agenda" class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-gold-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-stone-500 mb-1.5 uppercase tracking-widest">Deskripsi</label>
                        <textarea name="deskripsi" id="f_deskripsi" rows="3" class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-gold-500 outline-none resize-none transition-all"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 mb-1.5 uppercase tracking-widest">PIC</label>
                            <input type="text" name="pic" id="f_pic" class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm focus:border-gold-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 mb-1.5 uppercase tracking-widest">Status</label>
                            <select name="status" id="f_status" class="w-full px-4 py-2.5 bg-stone-50 border border-stone-200 rounded-xl text-sm outline-none bg-white cursor-pointer">
                                <option value="Upcoming">Upcoming</option>
                                <option value="Live">Live</option>
                                <option value="Selesai">Selesai</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full py-3.5 bg-charcoal-900 text-white font-bold rounded-xl hover:bg-charcoal-800 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> 
                        <span id="btnText">Simpan ke Rundown</span>
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                <h3 class="text-lg font-serif font-bold text-charcoal-900 mb-6 flex items-center gap-2">
                    <i data-lucide="list-ordered" class="w-5 h-5 text-gold-500"></i>
                    Urutan Jadwal Acara
                </h3>
                
                <div class="relative overflow-y-auto pr-2 custom-scroll" style="max-height: 550px;">
                    <div class="space-y-6 relative ml-4">
                        <div class="absolute left-[88px] top-0 bottom-0 w-0.5 bg-stone-100 -z-10"></div>
                        
                        {% for item in items %}
                        {% set jam = item.waktu.split(':')[0] | int if ':' in item.waktu else 0 %}
                        {% set kategori_waktu = 'Malam' if jam >= 17 else 'Pagi' %}
                        
                        <div class="flex gap-6 group relative rundown-item cursor-pointer" 
                             data-kategori="{{ kategori_waktu }}"
                             data-id="{{ item.id }}"
                             data-waktu="{{ item.waktu }}"
                             data-judul="{{ item.judul }}"
                             data-deskripsi="{{ item.deskripsi if item.deskripsi and item.deskripsi != 'None' else '' }}"
                             data-pic="{{ item.pic if item.pic and item.pic != 'None' else '' }}"
                             data-status="{{ item.status }}"
                             onclick="prepareEdit(this)">
                            
                            <div class="w-16 pt-1 text-right flex flex-col items-end shrink-0">
                                <div class="text-sm font-bold {% if item.status=='Live' %}text-green-600{% else %}text-charcoal-900{% endif %}">
                                    {{ item.waktu }}
                                </div>
                                {% if item.status=='Live' %}
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    <span class="text-[9px] text-green-500 font-bold uppercase animate-pulse">Live</span>
                                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="w-4 shrink-0"></div>
                            
                            <div class="flex-1 p-4 rounded-xl border-2 transition-all duration-200 item-card 
                                {% if item.status=='Live' %}border-green-500 bg-white shadow-sm{% else %}border-stone-100 bg-stone-50/30{% endif %} group-hover:border-gold-300 group-hover:bg-white">
                                
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-charcoal-900">{{ item.judul }}</h4>
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-0.5 text-[9px] uppercase rounded bg-white border border-stone-200 text-stone-500 font-bold">{{ item.status }}</span>
                                        <button onclick="event.stopPropagation(); if(confirm('Hapus agenda ini?')) window.location.href='/hapus_rundown/{{ item.id }}'" 
                                                class="opacity-0 group-hover:opacity-100 p-1 text-stone-400 hover:text-red-500 transition-all">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                </div>
                                <p class="text-xs text-stone-500 mb-2 leading-relaxed">{{ item.deskripsi }}</p>
                                <div class="text-[10px] text-stone-400 flex items-center gap-1.5">
                                    <i data-lucide="user" class="w-3 h-3"></i> PIC: {{ item.pic if item.pic and item.pic != 'None' else '-' }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function prepareEdit(el) {
    const data = {
        id: el.getAttribute('data-id'),
        waktu: el.getAttribute('data-waktu'),
        judul: el.getAttribute('data-judul'),
        deskripsi: el.getAttribute('data-deskripsi'),
        pic: el.getAttribute('data-pic'),
        status: el.getAttribute('data-status')
    };

    // Reset Highlight Card lain
    document.querySelectorAll('.item-card').forEach(c => {
        const isLive = c.classList.contains('border-green-500');
        c.classList.remove('border-gold-500', 'shadow-md', 'ring-2', 'ring-gold-100');
        // Jika bukan live, balikkan border ke default
        if (!isLive) {
            c.classList.add('border-stone-100');
        }
    });

    // Terapkan Highlight Emas pada Card yang dipilih (Tanpa menghapus border hijau jika sedang Live)
    const targetCard = el.querySelector('.item-card');
    targetCard.classList.add('border-gold-500', 'bg-white', 'shadow-md', 'ring-2', 'ring-gold-100');

    // Update UI Form
    document.getElementById('formTitle').innerHTML = '<i data-lucide="pencil" class="w-5 h-5 text-gold-500"></i> Edit Kegiatan';
    document.getElementById('btnText').innerText = "Update Jadwal";
    document.getElementById('resetBtn').classList.remove('hidden');
    document.getElementById('rundownForm').action = '/edit_rundown/' + data.id;

    // Isi Input
    document.getElementById('f_waktu').value = data.waktu;
    document.getElementById('f_judul').value = data.judul;
    document.getElementById('f_deskripsi').value = data.deskripsi;
    document.getElementById('f_pic').value = data.pic;
    document.getElementById('f_status').value = data.status;

    lucide.createIcons();
    if(window.innerWidth < 1024) document.getElementById('rundownForm').scrollIntoView({ behavior: 'smooth' });
}

function resetForm() {
    document.querySelectorAll('.item-card').forEach(c => {
        c.classList.remove('border-gold-500', 'shadow-md', 'ring-2', 'ring-gold-100');
        if (!c.classList.contains('border-green-500')) {
            c.classList.add('border-stone-100');
        }
    });
    document.getElementById('formTitle').innerHTML = '<i data-lucide="list-plus" class="w-5 h-5 text-gold-500"></i> Input Kegiatan';
    document.getElementById('btnText').innerText = "Simpan ke Rundown";
    document.getElementById('resetBtn').classList.add('hidden');
    document.getElementById('rundownForm').action = '/tambah_rundown';
    document.getElementById('rundownForm').reset();
    lucide.createIcons();
}

function filterRundown(kategori) {
    const items = document.querySelectorAll('.rundown-item');
    const tabResepsi = document.getElementById('tabResepsi');
    const tabAkad = document.getElementById('tabAkad');

    [tabResepsi, tabAkad].forEach(t => t.className = "flex-1 md:flex-none px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-stone-500 hover:text-charcoal-900");

    if(kategori === 'Pagi') {
        tabAkad.className = "flex-1 md:flex-none px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-gold-500 text-white shadow-md shadow-gold-500/20";
    } else {
        tabResepsi.className = "flex-1 md:flex-none px-8 py-2.5 rounded-xl text-sm font-bold transition-all bg-gold-500 text-white shadow-md shadow-gold-500/20";
    }

    items.forEach(item => {
        item.style.display = (item.getAttribute('data-kategori') === kategori) ? 'flex' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', () => filterRundown('Pagi'));
</script>
{% endblock %}