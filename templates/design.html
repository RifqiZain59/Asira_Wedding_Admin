{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="flex flex-col md:flex-row justify-end items-end mb-8 gap-4">
    <div class="flex gap-3">
        <a href="#" onclick="Swal.fire('Info', 'Mengarahkan ke halaman undangan live.', 'info')" class="px-4 py-2 border border-gold-500 text-gold-600 rounded-lg text-sm font-medium hover:bg-gold-50 flex items-center gap-2 transition-colors">
            <i data-lucide="eye" class="w-4 h-4"></i> Lihat Live Website
        </a>
        
        <input type="file" id="coverUpload" class="hidden" accept="image/*" onchange="handleFileUpload(this, 'cover')">
        <input type="file" id="twibbonUpload" class="hidden" accept="image/*" onchange="handleFileUpload(this, 'twibbon')">
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-7 space-y-8">
        
        <div class="bg-white rounded-xl border border-stone-100 shadow-sm overflow-hidden flex flex-col md:flex-row">
            <div class="bg-stone-100 p-8 flex justify-center items-center md:w-1/2 border-r border-stone-100 relative">
                <div class="relative w-[220px] h-[440px] bg-charcoal-900 rounded-[2rem] shadow-2xl border-[6px] border-charcoal-900 overflow-hidden ring-1 ring-stone-900/10 transition-all duration-500">
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-24 h-5 bg-charcoal-900 rounded-b-xl z-20"></div>
                    
                    {% if assets_cover and assets_cover|length > 0 %}
                        <img id="phoneWallpaper" src="{{ assets_cover[0].img_url }}" class="absolute inset-0 w-full h-full object-cover opacity-90 transition-opacity duration-500">
                    {% else %}
                        <img id="phoneWallpaper" src="https://images.unsplash.com/photo-1606800052052-a08af7148866?q=80&w=600" class="absolute inset-0 w-full h-full object-cover opacity-90 transition-opacity duration-500">
                    {% endif %}
                    
                    <div class="absolute inset-0 bg-black/30 flex flex-col justify-end pb-8 items-center text-center text-white px-4 z-10">
                        <p class="text-[8px] font-medium tracking-[0.2em] uppercase mb-2 opacity-80">The Wedding Of</p>
                        <h2 class="font-serif text-xl mb-1 transition-all leading-tight" id="previewNames">{{ config.judul_mempelai if config else 'Putra & Putri' }}</h2>
                        <p class="text-[10px] font-light opacity-80 mb-4" id="previewDate">{{ config.tanggal_acara if config else 'Minggu, 12 Oktober 2025' }}</p>
                        <div class="mb-4 p-3 rounded-lg bg-white/10 backdrop-blur-md border border-white/20 w-11/12 shadow-lg">
                            <p class="text-[8px] uppercase tracking-widest mb-1 opacity-70">Kepada Yth:</p>
                            <h4 class="font-bold text-xs truncate" id="previewGuestName">Nama Tamu</h4>
                        </div>
                        <div class="animate-bounce">
                            <button id="previewBtn" class="px-3 py-1 rounded-full bg-white/20 backdrop-blur-sm border border-white/50 text-[8px] uppercase tracking-widest hover:bg-white hover:text-charcoal-900 transition-all shadow-sm">Buka Undangan</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 md:w-1/2 flex flex-col justify-center space-y-4">
                <div class="pb-2 border-b border-stone-100">
                    <h3 class="font-serif font-bold text-lg text-charcoal-900 flex items-center gap-2"><i data-lucide="smartphone" class="w-5 h-5 text-gold-500"></i> Konfigurasi Cover</h3>
                </div>
                <div class="space-y-3">
                    <div><label class="block text-xs font-bold text-stone-500 mb-1">Judul Mempelai</label><input type="text" id="inputNama" value="{{ config.judul_mempelai if config else '' }}" oninput="updatePreview()" class="w-full px-3 py-2 border border-stone-200 rounded-lg text-xs focus:ring-1 focus:ring-gold-500"></div>
                    <div><label class="block text-xs font-bold text-stone-500 mb-1">Tanggal Acara</label><input type="text" id="inputTanggal" value="{{ config.tanggal_acara if config else '' }}" oninput="updatePreview()" class="w-full px-3 py-2 border border-stone-200 rounded-lg text-xs focus:ring-1 focus:ring-gold-500"></div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 mb-2">Tema Warna</label>
                        <input type="hidden" id="selectedTheme" value="{{ config.tema_warna if config else 'charcoal' }}">
                        <div class="flex gap-2">
                            <button onclick="changeTheme('charcoal')" class="w-6 h-6 rounded-full bg-charcoal-900 ring-2 ring-offset-2 ring-transparent hover:ring-gold-500 focus:ring-gold-500"></button>
                            <button onclick="changeTheme('gold')" class="w-6 h-6 rounded-full bg-[#D4AF37] ring-2 ring-offset-2 ring-transparent hover:ring-stone-300 focus:ring-stone-300"></button>
                            <button onclick="changeTheme('rustic')" class="w-6 h-6 rounded-full bg-[#8B5E3C] ring-2 ring-offset-2 ring-transparent hover:ring-[#8B5E3C] focus:ring-[#8B5E3C]"></button> 
                            <button onclick="changeTheme('sage')" class="w-6 h-6 rounded-full bg-[#8FA893] ring-2 ring-offset-2 ring-transparent hover:ring-[#8FA893] focus:ring-[#8FA893]"></button> 
                        </div>
                    </div>
                </div>
                <div class="pt-2">
                    <button onclick="saveSettings()" class="w-full py-2 bg-charcoal-900 text-white text-xs font-bold rounded-lg hover:bg-charcoal-800 transition-colors flex justify-center items-center gap-2"><i data-lucide="save" class="w-3 h-3"></i> Simpan</button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl border border-stone-100 shadow-sm">
            <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                <div><h3 class="font-bold text-charcoal-900 flex items-center gap-2"><i data-lucide="image" class="w-4 h-4 text-gold-500"></i> Galeri Background Sampul</h3></div>
                <button onclick="document.getElementById('coverUpload').click()" class="text-xs font-bold text-gold-600 hover:text-gold-700 flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Upload Cover</button>
            </div>
            
            <div class="grid grid-cols-3 md:grid-cols-4 gap-4 max-h-[300px] overflow-y-auto dash-scroll pr-2">
                {% if assets_cover %}
                    {% for asset in assets_cover %}
                    <div class="group relative aspect-[9/16] rounded-lg overflow-hidden border border-stone-200 cursor-pointer hover:shadow-md transition-all cover-item" onclick="selectCover(this, '{{ asset.img_url }}')">
                        <img src="{{ asset.img_url }}" class="w-full h-full object-cover">
                        <button onclick="deleteAsset('{{ asset.id }}', 'cover', this); event.stopPropagation();" class="absolute top-1 right-1 p-1 bg-white text-red-500 rounded-full opacity-0 group-hover:opacity-100 shadow-sm hover:scale-110 transition-all z-10"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-3 text-center text-xs text-stone-400 italic py-4">Belum ada cover.</div>
                {% endif %}

                <div onclick="document.getElementById('coverUpload').click()" class="aspect-[9/16] rounded-lg border-2 border-dashed border-stone-300 flex flex-col items-center justify-center text-stone-400 hover:border-gold-500 hover:text-gold-500 hover:bg-gold-50/50 cursor-pointer transition-all">
                    <i data-lucide="plus" class="w-6 h-6"></i><span class="text-[10px] mt-1 font-bold">Upload</span>
                </div>
            </div>
        </div>
    </div>

    <div class="lg:col-span-5 space-y-8">
        <div class="bg-charcoal-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden group">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-4 text-gold-400">
                    <i data-lucide="crop" class="w-5 h-5"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Twibbon Tool</span>
                </div>
                <h3 class="font-serif font-bold text-xl mb-1">Preview Frame</h3>
                <p class="text-xs text-stone-400 mb-6">Pilih frame dari galeri di bawah untuk melihat hasil.</p>
                
                <div class="aspect-square bg-white/10 rounded-xl border-2 border-dashed border-white/20 mb-6 flex flex-col items-center justify-center text-stone-400 relative overflow-hidden transition-colors">
                    {% if assets_twibbon and assets_twibbon|length > 0 %}
                         <img id="twibbonPreviewImg" src="{{ assets_twibbon[0].img_url }}" class="absolute inset-0 w-full h-full object-cover opacity-100 transition-transform duration-700">
                    {% else %}
                         <img id="twibbonPreviewImg" src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&q=80&w=400" class="absolute inset-0 w-full h-full object-cover opacity-60 transition-transform duration-700">
                    {% endif %}
                    <div class="absolute inset-4 border border-gold-500/80 rounded-lg flex items-end justify-center pb-2 pointer-events-none">
                        <span class="bg-gold-500 text-charcoal-900 text-[10px] font-bold px-2 py-0.5 shadow-lg">#AsiraWedding</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <button onclick="copyLinkTwibbon()" class="w-full py-2.5 border border-stone-600 text-stone-300 font-medium rounded-lg hover:bg-white/5 transition-colors flex items-center justify-center gap-2 text-sm"><i data-lucide="share-2" class="w-4 h-4"></i> Copy Link Generator</button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl border border-stone-100 shadow-sm">
            <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                <div><h3 class="font-bold text-charcoal-900 flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-gold-500"></i> Galeri Frame Twibbon</h3></div>
                <button onclick="document.getElementById('twibbonUpload').click()" class="text-xs font-bold text-gold-600 hover:text-gold-700 flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Upload Frame</button>
            </div>

            <div class="grid grid-cols-3 gap-3 max-h-[300px] overflow-y-auto dash-scroll pr-2">
                {% if assets_twibbon %}
                    {% for asset in assets_twibbon %}
                    <div class="group relative aspect-square rounded-lg overflow-hidden border border-stone-200 cursor-pointer bg-stone-50 hover:shadow-md transition-all twibbon-item" onclick="selectTwibbon(this, '{{ asset.img_url }}')">
                        <img src="{{ asset.img_url }}" class="w-full h-full object-cover">
                        <button onclick="deleteAsset('{{ asset.id }}', 'twibbon', this); event.stopPropagation();" class="absolute top-1 right-1 p-1 bg-white text-red-500 rounded-full opacity-0 group-hover:opacity-100 shadow-sm hover:scale-110 transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-3 text-center text-xs text-stone-400 italic py-4">Belum ada twibbon.</div>
                {% endif %}

                <div onclick="document.getElementById('twibbonUpload').click()" class="aspect-square rounded-lg border-2 border-dashed border-stone-300 flex flex-col items-center justify-center text-stone-400 hover:border-gold-500 hover:text-gold-500 hover:bg-gold-50/50 cursor-pointer transition-all">
                    <i data-lucide="plus" class="w-5 h-5"></i><span class="text-[10px] mt-1 font-bold">Baru</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = document.getElementById('selectedTheme').value;
        if(savedTheme) changeTheme(savedTheme);
    });

    function selectCover(element, imgUrl) {
        const wallpaper = document.getElementById('phoneWallpaper');
        wallpaper.style.opacity = '0';
        setTimeout(() => { wallpaper.src = imgUrl; wallpaper.style.opacity = '0.9'; }, 200);
        document.querySelectorAll('.cover-item').forEach(el => el.classList.remove('ring-4', 'ring-gold-500', 'ring-offset-2'));
        element.classList.add('ring-4', 'ring-gold-500', 'ring-offset-2');
    }

    function selectTwibbon(element, imgUrl) {
        const previewImg = document.getElementById('twibbonPreviewImg');
        previewImg.style.opacity = '0';
        setTimeout(() => { previewImg.src = imgUrl; previewImg.style.opacity = '1'; }, 200);
        document.querySelectorAll('.twibbon-item').forEach(el => el.classList.remove('ring-4', 'ring-gold-500', 'ring-offset-2'));
        element.classList.add('ring-4', 'ring-gold-500', 'ring-offset-2');
        Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'Frame Dipilih' });
    }

    function updatePreview() {
        document.getElementById('previewNames').innerText = document.getElementById('inputNama').value || "Putra & Putri";
        document.getElementById('previewDate').innerText = document.getElementById('inputTanggal').value || "Minggu, 12 Oktober 2025";
    }

    function changeTheme(theme) {
        document.getElementById('selectedTheme').value = theme;
        const btn = document.getElementById('previewBtn');
        const names = document.getElementById('previewNames');
        let color = '#FFFFFF', bg = 'rgba(255,255,255,0.2)';
        if (theme === 'gold') { color = '#D4AF37'; bg = '#D4AF37'; }
        else if (theme === 'rustic') { color = '#FFFFFF'; bg = '#8B5E3C'; }
        else if (theme === 'sage') { color = '#CDE6D2'; bg = '#8FA893'; }
        names.style.color = color;
        if (theme === 'gold') { btn.style.backgroundColor = bg; btn.style.color = '#000'; }
        else if (theme === 'charcoal') { names.style.color = '#FFF'; btn.style.backgroundColor = 'rgba(255,255,255,0.2)'; btn.style.color = '#FFF'; }
        else { btn.style.backgroundColor = bg; btn.style.color = '#FFF'; }
    }

    function saveSettings() {
        const data = {
            judul_mempelai: document.getElementById('inputNama').value,
            tanggal_acara: document.getElementById('inputTanggal').value,
            tema_warna: document.getElementById('selectedTheme').value
        };
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });
        fetch('/api/save_design_config', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        }).then(r => r.json()).then(d => Swal.fire({ icon: 'success', title: 'Disimpan!', timer: 1500, showConfirmButton: false }));
    }

    function handleFileUpload(input, type) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('tipe', type); 

            Swal.fire({ title: `Mengupload ${type}...`, didOpen: () => Swal.showLoading() });
            
            fetch('/api/add_asset', {
                method: 'POST',
                body: formData 
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    Swal.fire({ icon: 'success', title: 'Upload Berhasil!', timer: 1500, showConfirmButton: false })
                    .then(() => location.reload());
                } else {
                    console.error("Server Error:", d);
                    Swal.fire('Error', d.message || 'Gagal upload', 'error');
                }
            })
            .catch(e => {
                console.error("Network Error:", e);
                Swal.fire('Error', 'Gagal koneksi ke server. Cek Terminal untuk detail.', 'error');
            });
        }
    }

    function deleteAsset(id, type, btn) {
        Swal.fire({
            title: 'Hapus Aset?', text: "Data akan dihapus permanen.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/delete_asset/${type}/${id}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    const card = btn.closest('.group');
                    card.style.transition = "all 0.5s ease"; card.style.opacity = "0";
                    setTimeout(() => card.remove(), 500);
                    Swal.fire('Terhapus!', 'Aset berhasil dihapus.', 'success');
                });
            }
        })
    }

    function copyLinkTwibbon() {
        navigator.clipboard.writeText("https://asira.id/twibbon/demo");
        Swal.fire({ icon: 'success', title: 'Link Copied!', timer: 1000, showConfirmButton: false });
    }
</script>
{% endblock %}